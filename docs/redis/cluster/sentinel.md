# Redis哨兵模式
Redis Sentinel是针对需要当发生故障时自动进行主从切换，程序可以不用重启的一个高可用的解决方案。

可以将Redis Sentinel集群看成是一个zookeeper集群，它是集群高可用的心脏，一般由3~5个节点组成，这样即使别的节点挂了，集群还是可以正常运转。

## 理解原理
一个正常的分布图

![](./img/sentinel/2022-05-27-14-10-47.png)

Sentinel负责持续监控主从节点的健康，当主节点挂掉时，自动选择一个最优的从节点切换称为主节点。

客户端来连接集群时，会首先连接Sentinel，通过Sentinel来查询主节点的地址，然后再连接主节点进行数据交互。

当主节点发生故障时，客户端会重新向Sentinel要地址，Sentinel会将最新的主节点地址告诉客户端。

如此应用程序将无序重启即可自动完成节点的切换。

![](./img/sentinel/2022-05-27-14-24-59.png)

如上图，如果主节点挂掉，原先的主从复制也断开，客户端和损坏的主节点也断开。一个从节点被提升为新的主节点，其他从节点开始和新的主节点建立复制关系。

客户端通过新节点继续进行交互。

Sentinel会持续监控已经挂掉的主节点，待它恢复后，集群会调整为从节点，从新的主节点那里建立复制关系。

## 消息丢失问题
Redis是采用异步复制，主节点挂掉，从节点可能没有收到全部的消息，未同步部分就丢失了。

Sentinel无法保证消息完全不丢失，但也能尽量保证消息少丢失。

通过2个选项限制主从延迟过大

```
# 表示主节点必须至少有一个从节点在进行正常复制，否则就停止对外写服务，丧失可用性。
# 是否正常取决于下一个参数
min-slaves-to-write 1   

# 但是是秒，表示如果10s内没有收到从节点的反馈，就意味着从节点同步不正常。
# 要么是网络断开了，要么是一直没有给反馈
min-slaves-max-lage 10  
```

## 搭建一下
sentinel哨兵模式已经被集成在redis2.4之后的版本中。

一般建议sentinel采取奇数台，防止某一台sentinel无法连接到master导致误切换。